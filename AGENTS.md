# AGENTS.md

Triumvirate is a Node.js/TypeScript CLI that runs code reviews across OpenAI, Claude, and Gemini models, then synthesizes findings to surface issues with cross-model consensus.

## Setup Commands

- Install deps: `npm install`
- Build: `npm run build`
- Run tests: `npm test`
- Lint & type-check: `npm run verify`
- Format code: `npm run format`

## Project Structure

- `src/` – TypeScript source files
  - `src/cli/actions/` – CLI command handlers (runAction, planAction, nextAction, etc.)
  - `src/utils/` – Utility modules (llm-providers, report-utils, error-handling)
  - `src/types/` – TypeScript type definitions
  - `src/prompts/` – System prompts for LLM interactions
- `baml_src/` – BAML function definitions for structured LLM outputs
- `test/` – Vitest unit tests
- `scripts/` – Helper scripts (check-coverage, e2e-test, etc.)
- `dist/` – Compiled JavaScript output (generated by build)

## Code Style

- TypeScript strict mode with ESLint
- Prettier formatting (run `npm run format` before committing)
- Use functional patterns where possible
- JSDoc comments on exported functions
- No unused variables or imports

## Testing Instructions

- Run `npm test` to execute all Vitest tests
- Run `npm run verify` to check linting, formatting, and types
- Always run both before committing: `npm test && npm run verify`
- Add tests for new functionality in `test/` directory
- E2E tests are in `test/e2e.test.ts` (skipped by default, require API keys)

## Common Use Cases

### 1. Run a Code Review

```bash
npx triumvirate review
# Or with specific models
npx triumvirate review --models openai,claude,gemini
```

### 2. Review Only Changed Files

```bash
npx triumvirate review --diff
```

### 3. Generate Task Plan from Review

```bash
npx triumvirate plan
npx triumvirate next --input plan.json
```

### 4. List Available Models

```bash
npx triumvirate models
```

## Key Files to Understand

- `src/index.ts` – Main entry point, exports `runTriumvirateReview`
- `src/cli/cliRun.ts` – CLI command definitions using Commander.js
- `src/utils/llm-providers.ts` – LLM provider abstractions (OpenAI, Claude, Gemini)
- `src/utils/report-utils.ts` – Report generation and findings extraction
- `src/utils/baml-providers.ts` – BAML-based structured output functions
- `baml_src/functions.baml` – BAML function definitions

## Environment Variables

Required API keys (set at least one):

- `OPENAI_API_KEY` – OpenAI API key
- `ANTHROPIC_API_KEY` – Anthropic/Claude API key
- `GEMINI_API_KEY` – Google Gemini API key

Optional:

- `USE_BAML=true` – Use BAML for structured LLM outputs

## PR Instructions

- Title format: `type: description` (e.g., `fix: improve CLI validation`)
- Run `npm test && npm run verify` before committing
- Ensure all tests pass and no linting errors
- Add tests for bug fixes and new features

## Security Considerations

- Never commit API keys or `.env` files
- API keys should only be in environment variables
- Be cautious when sending code to LLM providers (sensitive data filtering)

## Debugging Tips

- Use `--verbose` flag for detailed logging: `npx triumvirate review --verbose`
- Check `tri-review-api-calls.jsonl` for API call logs
- Review findings are saved to `tri-review-findings.json`
- Output reports go to `.triumvirate/` directory by default
